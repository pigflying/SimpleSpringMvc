# 医生版4.1

## 下拉加载消息

- 初始通过websocket返回
- App进行query

### 查询(query)

- 患者消息，科室消息，好友消息，群聊消息，小杏消息
- stanza: (message, departMessage, friendMessage, groupChatMessage, xiaoxingMessage)
- params: (patientId, departId, friendId, groupId, -)
- 例如：患者消息
```
{
    "stanza": "message", 
    "op": "query",
    "params": {
        "patientId": < 患者ID >
        "deliverId": < 最小的ID >
    },
    "guid": < 消息GUID > 
}
```
### 返回值

- 患者消息，科室消息，好友消息，群聊消息，小杏消息返回的message结构与初始化数据(带有since)结构相同
- 例如：患者消息
```
{
    "stanza": "message" ,
    "message": [{
        "doctorId": < 医生ID >,
        "patientId": < 患者ID >,
        "receiverId": < 收ID >
        "content": < 消息内容 >,
        "typ": < 消息类别 >,
        "guid": < 消息guid >,
        "status": < 消息状态 >,
        "visibility": < 消息的可见性 >
        "id": < 消息编号 >,
        "created": < 创建时间 >
        }...],
    "updated": updated    
    "guid": < Stanza的GUID >
}
```
### 实现

- 如果请求参数有deliverId, 返回小于deliverId的二十条消息.
- 如果没有参数deliverId, 返回最新的20条消息

## 快捷回复数据后台读取

- 数据库表结构

```
CREATE TABLE IF NOT EXISTS `QuickReplyMessage` (
  `id` int(11) NOT NULL,
  `doctorId` int(11) NOT NULL COMMENT '医生ID' ,
  `content` varchar(500) CHARACTER SET utf8 NOT NULL COMMENT '消息内容',
  `updated` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=ascii ROW_FORMAT=DYNAMIC COMMENT='医生快捷回复消息';
```

### 获取医生所有的快捷消息

- `URL: /api/quickReply/list`
- 按照updated进行排序，默认消息放到最后，无需分页

### 方法

- POST (x-www-form-urlencoded)

### 返回值: 
```
{
    "success": true,
    "quickMessage": [{
        "id": < 快捷消息ID >,
        "message": < 快捷消息内容 >
    }...]
}
```
### 新增快捷回复消息

- `URL: /api/quickReply/add`

### 方法

- POST (x-www-form-urlencoded)

### 参数

- message 快捷消息内容

> message不能为空

### 返回值: 
```
{
    "success": true,
    "quickMessage": {
        "id": < 快捷消息ID >,
        "message": < 快捷消息内容 >
    }
}
```
### 修改快捷回复消息

- `URL: /api/quickReply/mod`

### 方法

- POST (x-www-form-urlencoded)

### 参数

- id 消息ID
- message 快捷消息内容

> id和message都不能为空

### 返回值: 
```
{
    "success": true,
    "quickMessage": {
        "id": < 快捷消息ID >,
        "message": < 快捷消息内容 >
    }
}
```
> app需要用返回结果更新掉老的记录（包括id）

### 删除快捷回复消息

- `URL: /api/quickReply/<quickId>/delete`

### 方法

- GET

### 返回值: 
```
{
    "success": true
}
```
### 快捷回复默认消息处理（后台）

- 默认消息设置为常量
- 删除：如果是默认消息数据库插入一条记录，其他删除指定记录
- 修改：如果修改的是默认消息，新建两条记录，默认消息和修改之后消息，返回修改之后消息，其他执行修改操作
- list：读取list，过滤掉包含的默认消息，追加不包含的默认消息
